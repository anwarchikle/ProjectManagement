<template>
    <div class="page-container">

        <!-- Fixed Header -->
        <!-- <div class="fixed-header edit-header">
            <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center slds-p-around_small slds-m-around_medium">
                <div class="slds-col"></div>

                <div class="slds-col slds-text-align_center">
                    <h2 class="header-title">Edit Task</h2>
                </div>
                <div class="slds-col slds-text-align_right">
                </div>
            </div>
        </div> -->

        <!-- Scrollable Task Form -->
        <div class="scrollable-tasks" if:true={isLoading}>
            <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
        </div>

        <div class="scrollable-tasks" if:false={isLoading}>
            <template if:true={task}>
                <div class="task-row slds-border_bottom">
                    <div class="slds-grid slds-wrap slds-gutters_large slds-m-around_medium">

                        <!-- Row 1 -->
                        <div class="slds-col slds-size_1-of-5">
                            <lightning-input label="Task Name" name="taskName" value={task.taskName}
                                onchange={handleInputChange} required>
                            </lightning-input>
                        </div>

                        <div class="slds-col slds-size_1-of-5">
                            <lightning-record-picker
                                label="Project"
                                object-api-name="Project__c"
                                value={task.project}     
                                onchange={handleProjectChange}
                                required>
                            </lightning-record-picker>
                        </div>

                        <div class="slds-col slds-size_1-of-5">
                            <lightning-combobox label="Milestone" name="milestone" options={task.milestoneOptions}
                                value={task.milestone} onchange={handleMilestoneChange}
                                disabled={task.milestoneDisabled} required placeholder="Select Milestone">
                            </lightning-combobox>
                        </div>

                        <div class="slds-col slds-size_1-of-5">
                            <lightning-combobox label="Task List" name="taskList" options={task.taskListOptions}
                                value={task.taskList} onchange={handleTaskListChange}
                                disabled={task.taskListDisabled} required placeholder="Select Task List">
                            </lightning-combobox>
                        </div>

                        <div class="slds-col slds-size_1-of-5">
                            <c-lwc-multi-lookup 
                                label="Team Members" 
                                object-name="User" 
                                field-name="Email"
                                selected-contact-list={task.teamMembersForChild}
                                onselected={handleTeamMembersChange} 
                                required>
                            </c-lwc-multi-lookup>
                        </div>

                        <!-- Row 2 -->

                        <div class="slds-col slds-size_1-of-5">
                            <lightning-combobox label="Priority" name="priority" options={priorityOptions}
                                value={task.priority} onchange={handleComboboxChange} required>
                            </lightning-combobox>
                        </div>

                        <div class="slds-col slds-size_1-of-5">
                            <lightning-combobox label="Billing Type" name="billingType" options={billingOptions}
                                value={task.billingType} onchange={handleComboboxChange} required>
                            </lightning-combobox>
                        </div>

                        <div class="slds-col slds-size_1-of-5">
                            <lightning-input type="date" label="Start Date" name="startDate"
                                value={task.startDate} onchange={handleStartDateChange} min={todayDate} required>
                            </lightning-input>
                        </div>

                        <div class="slds-col slds-size_1-of-5">
                            <lightning-input type="date" label="End Date" name="endDate"
                                value={task.endDate} onchange={handleEndDateChange} min={task.minEndDate}
                                disabled={task.endDateDisabled} required>
                            </lightning-input>
                        </div>

                        <div class="slds-col slds-size_1-of-5">
                            <lightning-input type="number" label="Work Hours" name="workHours"
                                value={task.workHours} disabled={task.workHoursDisabled}
                                readonly={task.workHoursReadOnly} onchange={handleWorkHoursManualChange}
                                onblur={handleWorkHoursManualBlur}>
                            </lightning-input>
                        </div>
                        
                        <!-- Row 3 -->
                        <!-- ================= COMMENT SECTION ================= -->
                        <div class="slds-col slds-size_1-of-1 slds-m-top_medium">
                            <div class="slds-box slds-theme_default slds-m-top_medium">
                                <lightning-input-rich-text
                                    label="Comment"
                                    placeholder="Add comments or notes for this task..."
                                    value={task.comments}
                                    onchange={handleCommentChange}>
                                </lightning-input-rich-text>
                            </div>
                        </div>

                        <!-- ======== WORK ALLOCATION PANEL (opens only when Flexible is toggled ON) ======== -->
                        <div class="slds-col slds-size_1-of-1" if:true={task.isAllocOpen}>
                            <div class="alloc-panel slds-m-top_small">

                                <!-- Header -->
                                <div class="alloc-header slds-grid slds-grid_align-spread slds-grid_vertical-align-center slds-p-around_small slds-m-bottom_small">
                                    <div class="slds-media slds-media_center">
                                        <lightning-icon icon-name="utility:table" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                        <div class="slds-media__body">
                                            <h3 class="alloc-title">
                                                Work Allocation <span class="mode-pill">Flexible</span>
                                            </h3>
                                            <span class="slds-text-body_small slds-text-color_weak">Daily baseline: 8h</span>
                                        </div>
                                    </div>
                                    <div class="slds-text-align_right">
                                        <span class="slds-text-title slds-text-color_weak">Total</span>
                                        <span class="slds-text-heading_small slds-m-left_x-small">{task.workHours}h</span>
                                    </div>
                                </div>

                                <!-- ===================== FLEXIBLE MODE ONLY ===================== -->
                                <template if:true={task.isFlexible}>
                                    <div class="alloc-3pane flexible" data-alloc="0">
                                        <!-- LEFT: Owner (fixed) -->
                                        <div class="pane-left">
                                            <!-- Header -->
                                            <div class="row header">
                                                <div class="cell-title">Owner</div>
                                            </div>

                                            <!-- BODY: scrollable -->
                                            <div class="users-scroll">
                                                <template for:each={task.allocationRows} for:item="row">
                                                    <div key={row.userId} class="row" style="margin-bottom: 12px;">
                                                        <div class="owner-line">
                                                            <span class="avatar">{row.initials}</span>
                                                            <span class="owner-name">{row.name}</span>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>

                                        <!-- CENTER: scroll container -->
                                        <div class="pane-center">
                                            <div class="dates-scroll">
                                                <!-- Header (dates) -->
                                                <div class="row header no-border">
                                                    <div class="dates-grid">
                                                        <template for:each={task.dateColumns} for:item="col">
                                                            <div key={col.date} class="date-col">{col.label}</div>
                                                        </template>
                                                    </div>
                                                </div>

                                                <!-- BODY: scrollable vertically -->
                                                <div class="users-scroll">
                                                    <template for:each={task.allocationRows} for:item="row" for:index="uIndex">
                                                        <div key={row.userId} class="row">
                                                            <div class="dates-grid">
                                                                <template for:each={row.cells} for:item="cell" for:index="cIndex">
                                                                    <div key={cell.date} class="cell-col">
                                                                        <div class="cell-stack">
                                                                            <div class="cell-top">
                                                                                <lightning-input
                                                                                    type="number"
                                                                                    variant="label-hidden"
                                                                                    step="0.25"
                                                                                    min="0"
                                                                                    max="12"
                                                                                    inputmode="decimal"
                                                                                    value={cell.hours}
                                                                                    data-userindex={uIndex}
                                                                                    data-dateindex={cIndex}
                                                                                    onkeydown={blockInvalidKeys}
                                                                                    onpaste={sanitizePaste}
                                                                                    onchange={handleCellHoursChange}
                                                                                    onblur={handleCellHoursBlur}>
                                                                                </lightning-input>
                                                                            </div>
                                                                            <div class="cell-bottom">
                                                                                <span class={cell.badgeClass}>{cell.percent}</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- RIGHT: Totals (fixed) -->
                                        <div class="pane-right">
                                            <!-- Header -->
                                            <div class="row header right" style="padding: 0;">
                                                <div class="cell-title">Total Hours</div>
                                            </div>

                                            <!-- BODY: scrollable vertically -->
                                            <div class="users-scroll">
                                                <template for:each={task.allocationRows} for:item="row">
                                                    <div key={row.userId} class="row right" style="margin-bottom: 12px;">
                                                        <div class="total-val">{row.total}h</div>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <!-- ======== END WORK ALLOCATION PANEL ======== -->

                        <!-- Row Actions: Upload Files & Toggle (Flexible) -->
<div class="slds-col slds-size_1-of-1 slds-text-align_right slds-m-top_medium row-actions">
    
    <!-- File Upload Button -->
    <lightning-button 
        variant="neutral" 
        label="Upload Files"
        icon-name="utility:upload"
        onclick={handleUploadFiles}
        class="slds-m-right_x-small">
    </lightning-button>
    
    <!-- Flexible / Standard Allocation Toggle -->
    <lightning-button-stateful
        class="alloc-toggle slds-m-right_x-small"
        selected={task.isAllocOpen}
        label-when-off="Allocate Flexible Hour"
        label-when-on="Allocate Standard Hour"
        icon-name-when-off="utility:chevrondown"
        icon-name-when-on="utility:chevronup"
        variant="brand-outline"
        onclick={handleToggleAlloc}>
    </lightning-button-stateful>
</div>

<!-- Compact File Preview Section (if files exist) -->
<div class="slds-col slds-size_1-of-1" if:true={hasFiles}>
    <div class="slds-box slds-theme_shade slds-m-top_small">
        <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center slds-m-bottom_x-small">
            <h3 class="slds-text-heading_small">
                <lightning-icon icon-name="utility:attach" size="x-small" class="slds-m-right_xx-small"></lightning-icon>
                Attached Files ({fileCount})
            </h3>
        </div>
        
        <!-- Compact File List -->
        <div class="file-list-compact">
            <template for:each={task.files} for:item="file">
                <div key={file.documentId} class="file-item-compact">
                    <div class="file-info">
                        <lightning-icon icon-name={file.icon} size="x-small"></lightning-icon>
                        <span class="file-name" title={file.fileName}>{file.fileName}</span>
                        <span class="file-size">({file.fileSizeFormatted})</span>
                    </div>
                    <div class="file-actions">
                        <lightning-button-icon 
                            icon-name="utility:preview" 
                            variant="bare"
                            alternative-text="Preview"
                            title="Preview"
                            data-id={file.documentId}
                            onclick={handlePreviewFile}>
                        </lightning-button-icon>
                        <lightning-button-icon 
                            icon-name="utility:delete" 
                            variant="bare"
                            alternative-text="Remove"
                            title="Remove"
                            data-id={file.documentId}
                            onclick={handleRemoveFile}>
                        </lightning-button-icon>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Fixed Footer -->
        <div class="fixed-footer">
            <div class="slds-text-align_center">
                <lightning-button variant="neutral" label="Cancel" onclick={handleCancel}>
                </lightning-button>
                &nbsp;&nbsp;
                <lightning-button variant="brand" label="Update Task" onclick={handleUpdate}>
                </lightning-button>
            </div>
        </div>

    </div>
</template>